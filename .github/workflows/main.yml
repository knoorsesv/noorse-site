name: Noorse site CI

on:
  push:
    tags:
      - 'v*.*.*'
  pull_request:
    branches: [master]

jobs:
  build-prod:
    runs-on: ubuntu-latest
    name: Build PROD
    steps:
      - uses: actions/checkout@v1
      - uses: bahmutov/npm-install@v1
        env:
          NPM_TOKEN: ${{secrets.NPM_TOKEN}}
      - run: yarn build
        env:
          NPM_TOKEN: ${{secrets.NPM_TOKEN}}
          GA_TRACKING_ID: ${{secrets.GA_TRACKING_ID}}
          CONTENTFUL_TOKEN: ${{secrets.CONTENTFUL_TOKEN}}
          CONTENTFUL_SPACE_ID: ${{secrets.CONTENTFUL_SPACE_ID}}
          PROD: true
          TRACKING: ${{ startsWith(github.ref, 'refs/tags/v') }}
      - name: Deploy
        uses: nwtgck/actions-netlify@v1
        id: deploy-prod
        with:
          publish-dir: './public'
          production-deploy: ${{ startsWith(github.ref, 'refs/tags/v') }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: 'Deploy ${{ github.ref }}'
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: cfb311e2-904f-4acb-9937-30e50d59f3ca
    outputs:
      prod-url: ${{steps.deploy-prod.outputs.deploy-url}}

  build-dev:
    if: ${{ !startsWith(github.ref, 'refs/tags/v') }}
    runs-on: ubuntu-latest
    name: Build DEV
    steps:
      - uses: actions/checkout@v1
      - uses: bahmutov/npm-install@v1
        env:
          NPM_TOKEN: ${{secrets.NPM_TOKEN}}
      - run: yarn build
        env:
          PERCY_TOKEN: ${{secrets.PERCY_TOKEN}}
          NPM_TOKEN: ${{secrets.NPM_TOKEN}}
          CONTENTFUL_TOKEN_PREVIEW: ${{secrets.CONTENTFUL_TOKEN_PREVIEW}}
          CONTENTFUL_TOKEN: ${{secrets.CONTENTFUL_TOKEN}}
          CONTENTFUL_SPACE_ID: ${{secrets.CONTENTFUL_SPACE_ID}}
          CONTENTFUL_ENV: staging
      - name: Deploy
        uses: nwtgck/actions-netlify@v1
        id: deploy-dev
        with:
          publish-dir: './public'
          production-deploy: ${{ false }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: 'Deploy ${{ github.ref }}'
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: cfb311e2-904f-4acb-9937-30e50d59f3ca
    outputs:
      dev-url: ${{steps.deploy-dev.outputs.deploy-url}}

  cypress-test:
    needs: build-dev
    if: contains(github.event_name, 'pull_request')
    runs-on: ubuntu-latest
    container: cypress/browsers:node12.14.1-chrome85-ff81
    name: Cypress Test
    steps:
      - name: Checkout
        uses: actions/checkout@v1
      - uses: cypress-io/github-action@v2
        with:
          build: yarn build:css
          config: baseUrl=https://5f7f659e7b37d50132a1a9e7--modest-golick-edc673.netlify.app
          record: true
          tag: ${{ github.event_name }}
          browser: chrome
        env:
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
          COMMIT_INFO_MESSAGE: ${{ github.event.pull_request.title }}
          NPM_TOKEN: ${{secrets.NPM_TOKEN}}

  lighthouse-check:
    needs: build-prod
    if: contains(github.event_name, 'pull_request')
    runs-on: ubuntu-latest
    name: Lighthouse Check
    steps:
      - uses: actions/checkout@v1
      - name: Audit URLs using Lighthouse
        uses: treosh/lighthouse-ci-action@v3
        with:
          urls: |
            ${{needs.build-prod.outputs.prod-url}}
          configPath: './lighthouserc.json'
          temporaryPublicStorage: true
        env:
          LHCI_GITHUB_APP_TOKEN: ${{secrets.LHCI_GITHUB_APP_TOKEN}}
